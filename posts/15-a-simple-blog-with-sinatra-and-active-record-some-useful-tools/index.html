<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>A Simple Blog with Sinatra and Active Record ( + some useful tools)</title>
    <link rel="stylesheet" href="/css/skeleton/base.css" />
    <link rel="stylesheet" href="/css/skeleton/layout.css" />
    <link rel="stylesheet" href="/css/skeleton/skeleton.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/pygments.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
          <a href="/" class="logo">
            <div class="back">&larr;</div>
            <h1>danneu</h1>
          </a> &mdash;
          <ul>
            <li><a href="/about-me">about me</a></li> &mdash;
            <li><a href="/projects">projects</a></li>
          </ul>
      </div>
      <h1>A Simple Blog with Sinatra and Active Record ( + some useful tools)</h1>

<div class="post-meta row">
  <div class="eight columns alpha post-author">
    by <a href="/about-me">Dan</a>
  </div>
  <div class="eight columns omega post-date">
    23 Oct 2012
  </div>
</div>

<div class="post-content">
  <h1>Objective</h1>

<p>Sinatra is often suggested to newbies as an easy framework, but I imagine its lack of post-readme documentation makes it pretty daunting once you get past &quot;Hello World&quot;. Doing something like hooking up a database is non-obvious, and writing glue code just isn&#39;t newbie friendly.</p>

<p>This tutorial is extracted from a comprehensive 8,000 word tutorial I wrote last weekend that explains why I&#39;m actually doing the things that I&#39;m doing, but it&#39;s way too aimless, verbose, and meandering. Here&#39;s a more easily digested quickstart guide.</p>

<h1>What we&#39;ll be building</h1>

<p>We&#39;ll be making a blog. It won&#39;t be pretty, but it&#39;ll include these features:</p>

<ul>
<li>Migrations: the ability to apply and rollback changes to our database (like creating our table of posts).</li>
<li>Show all of our posts on our homepage</li>
<li>Individual pages for each blog post</li>
<li>Appropriate forms and buttons to create/update/destroy our blog posts</li>
<li>Helper methods that let us simplify our templates.</li>
<li>A place to put our static pages like &quot;About Me&quot;.</li>
<li>A RESTful interface.</li>
<li>Layouts, partial templates, and regular templates.</li>
<li>MVC pattern</li>
<li>Validations on our posts</li>
</ul>

<p><img src="http://dl.dropbox.com/u/51836583/Screenshots/6p.png" alt="Screenshot of end product"></p>

<h1>What our file hierarchy will look like</h1>

<p>Some of these files/directories will be automatically generated.</p>
<div class="highlight"><pre><code class="ruby"><span class="o">--</span> <span class="n">blog</span><span class="o">/</span>
   <span class="o">+--</span> <span class="no">Gemfile</span>                       <span class="c1"># Lists our gem dependencies</span>
   <span class="o">+--</span> <span class="no">Rakefile</span>                      <span class="c1"># Contains helpful tasks we can run from command line</span>
   <span class="o">+--</span> <span class="n">config</span><span class="o">.</span><span class="n">ru</span>                     <span class="c1"># A conventional file used for deploying and integrating with some tools</span>
   <span class="o">+--</span> <span class="n">app</span><span class="o">.</span><span class="n">rb</span>                        <span class="c1"># The guts of our Sinatra app</span>
   <span class="o">+--</span> <span class="n">blog</span><span class="o">.</span><span class="n">db</span>                       <span class="c1"># Our SQLite3 database</span>
   <span class="o">+--</span> <span class="n">views</span><span class="o">/</span>                        <span class="c1"># Contains our templates</span>
       <span class="o">+--</span> <span class="n">layout</span><span class="o">.</span><span class="n">erb</span>                <span class="c1"># HTML that&#39;s displayed on every page and embeds the other templates</span>
       <span class="o">+--</span> <span class="n">_delete_post_button</span><span class="o">.</span><span class="n">erb</span>   <span class="c1"># A partial template to extract some ugly HTML from our view</span>
       <span class="o">+--</span> <span class="n">pages</span><span class="o">/</span>              
           <span class="o">+--</span> <span class="n">about</span><span class="o">.</span><span class="n">erb</span>
       <span class="o">+--</span> <span class="n">posts</span><span class="o">/</span>
           <span class="o">+--</span> <span class="n">index</span><span class="o">.</span><span class="n">erb</span>
           <span class="o">+--</span> <span class="n">show</span><span class="o">.</span><span class="n">erb</span>
           <span class="o">+--</span> <span class="kp">new</span><span class="o">.</span><span class="n">erb</span>
           <span class="o">+--</span> <span class="n">edit</span><span class="o">.</span><span class="n">erb</span>
</code></pre></div>
<h1>The gems we&#39;ll use</h1>

<ul>
<li><code>sinatra</code>: the framework</li>
<li><code>sqlite3</code>: the database</li>
<li><code>activerecord</code>: the interface to our database</li>
<li><code>sinatra-activerecord</code>: a bridge that lets us use Active Record</li>
<li><code>shotgun</code>: a development server that reloads our app code on each request so we don&#39;t need to restart the server to see our changes.</li>
<li><code>tux</code>: a console that lets us run Ruby code in the environment of our app/database.</li>
</ul>
<div class="highlight"><pre><code class="ruby"><span class="c1"># Gemfile</span>
<span class="n">source</span> <span class="ss">:rubygems</span>

<span class="n">gem</span> <span class="s2">&quot;sinatra&quot;</span>
<span class="n">gem</span> <span class="s2">&quot;sqlite3&quot;</span>
<span class="n">gem</span> <span class="s2">&quot;activerecord&quot;</span>
<span class="n">gem</span> <span class="s2">&quot;sinatra-activerecord&quot;</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s2">&quot;shotgun&quot;</span>
  <span class="n">gem</span> <span class="s2">&quot;tux&quot;</span>
<span class="k">end</span>
</code></pre></div>
<p>Install and lock &#39;em: <code>$ bundle install</code></p>

<h1>Our config.ru</h1>

<p>Including a <strong>config.ru</strong> file is a convention that some deployment procedures and tools (like shotgun, tux, and Heroku) look for. It just includes the code of our app and tells a handler what to run.</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># config.ru</span>
<span class="nb">require</span> <span class="s2">&quot;./app&quot;</span>
<span class="n">run</span> <span class="ss">Sinatra</span><span class="p">:</span><span class="ss">:Application</span>
</code></pre></div>
<h1>Booting up the server and our console</h1>

<p>In one terminal, start the server:</p>
<div class="highlight"><pre><code class="ruby"><span class="err">$</span> <span class="n">shotgun</span>
</code></pre></div>
<p>In another, start our console:</p>
<div class="highlight"><pre><code class="ruby"><span class="err">$</span> <span class="n">tux</span>
</code></pre></div>
<h1>Setting up the database and our Post model</h1>

<p>Our database will be written to <code>blog.db</code> in the root of our app&#39;s directory.</p>

<p>Our Post model, while empty, is all Active Record needs to see to know to expose us methods that will operate on an underlying table called &quot;posts&quot;. </p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># app.rb</span>
<span class="nb">require</span> <span class="s2">&quot;sinatra&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;sinatra/activerecord&quot;</span>

<span class="n">set</span> <span class="ss">:database</span><span class="p">,</span> <span class="s2">&quot;sqlite3:///blog.db&quot;</span>

<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
<span class="k">end</span>
</code></pre></div>
<p>Type <code>Post.all</code> into the tux console and it&#39;ll let you know that no posts table exists yet:</p>
<div class="highlight"><pre><code class="ruby"><span class="err">$</span> <span class="n">tux</span>
<span class="o">&gt;&gt;</span> <span class="no">Post</span><span class="o">.</span><span class="n">all</span>
<span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:StatementInvalid</span><span class="p">:</span> <span class="no">Could</span> <span class="ow">not</span> <span class="n">find</span> <span class="n">table</span> <span class="s1">&#39;posts&#39;</span>
</code></pre></div>
<h2>Including some rake rasks</h2>

<p>Rake tasks are helpful commands we can run from our command line. The <code>sinatra-activerecord</code> gem comes with some. Let&#39;s include them in our Rake file:</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># Rakefile</span>
<span class="nb">require</span> <span class="s2">&quot;./app&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;sinatra/activerecord/rake&quot;</span>
</code></pre></div>
<p>You can get a list of available rake tasks by running <code>$ rake -T</code>:</p>

<ul>
<li><code>rake db:create_migration NAME=name_of_migration</code>: creates a new migration file in <code>db/migrate/</code>.</li>
<li><code>rake db:migrate</code>: apply all migrations to the database that have no been applied.</li>
<li><code>rake db:rollback</code>: undo the previous migration</li>
</ul>

<h2>Writing our first migration</h2>
<div class="highlight"><pre><code class="ruby"><span class="err">$</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="n">create_migration</span> <span class="no">NAME</span><span class="o">=</span><span class="n">create_posts</span>
</code></pre></div>
<p>This will generate the directory structure and file: <code>db/migrate/201210231234_create_posts.rb</code>. That timestamp is how Active Record knows the order in which migrations should be applied to the database.</p>

<p>Let&#39;s open it up and write what happens to the database when this migration is applied.</p>

<ul>
<li><strong>Note</strong>: Active Record&#39;s API is outside the scope of this tutorial. In fact, it&#39;s one of the learning curves of Ruby on Rails. Fortunately, the Ruby Guide on Active Record talks about the same gem, so check it out: <a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a>.</li>
</ul>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">CreatePosts</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:posts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:title</span>
      <span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="ss">:body</span>
      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span> <span class="s2">&quot;My first post&quot;</span><span class="p">,</span> <span class="ss">body</span><span class="p">:</span> <span class="s2">&quot;And this is the post&#39;s content.&quot;</span><span class="p">)</span>
    <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span> <span class="s2">&quot;How to lasso your dog&quot;</span><span class="p">,</span> 
                <span class="ss">body</span><span class="p">:</span> <span class="s2">&quot;1. Tie a rope into a lasso. 2. Swing it over that unruly dog&#39;s torso. 3. Gently pull.&quot;</span><span class="p">)</span>
    <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span> <span class="s2">&quot;Top 10 coffee shops in Austin&quot;</span><span class="p">,</span> <span class="ss">body</span><span class="p">:</span> <span class="s2">&quot;1..10: Epoch Coffee, the 24/7 coffee shop.&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="n">drop_table</span> <span class="ss">:posts</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>That gives our posts these columns:</p>

<ul>
<li>id (maintained by Active Record)</li>
<li>title</li>
<li>body</li>
<li>created_at (maintained by Active Record)</li>
<li>updated_at (maintained by Active Record) </li>
</ul>

<p>I also included three sample posts.</p>

<p>The up method is run when migrating, the down method is run when rolling back the migration.</p>

<h2>Run the migration</h2>
<div class="highlight"><pre><code class="ruby"><span class="err">$</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="n">migrate</span>
</code></pre></div>
<p>It should indicate that the posts table was created.</p>

<h2>Verify in tux</h2>

<p>In the tux console:</p>
<div class="highlight"><pre><code class="ruby"><span class="err">$</span> <span class="n">tux</span>
<span class="o">&gt;&gt;</span> <span class="no">Post</span><span class="o">.</span><span class="n">count</span>
<span class="mi">3</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">title</span><span class="p">:</span> <span class="s2">&quot;My Post&quot;</span><span class="p">,</span> <span class="ss">body</span><span class="p">:</span> <span class="s2">&quot;This is exciting!&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span> <span class="o">=</span> <span class="n">new_record?</span>
<span class="kp">true</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="o">.</span><span class="n">save</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="o">.</span><span class="n">new_record?</span>
<span class="kp">false</span>
<span class="o">&gt;&gt;</span> <span class="no">Post</span><span class="o">.</span><span class="n">count</span>
<span class="mi">4</span>
</code></pre></div>
<h1>Our blog&#39;s homepage: a list of posts</h1>

<p>Now that our backend is set up, let&#39;s hook it up to our website. When somebody visits our blog&#39;s root url <code>/</code>, they should see a list of our blog posts in the order in which they were created at.</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># app.rb</span>
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="n">get</span> <span class="s2">&quot;/&quot;</span> <span class="k">do</span>
  <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s2">&quot;created_at DESC&quot;</span><span class="p">)</span>
  <span class="n">erb</span> <span class="ss">:&quot;posts/index&quot;</span>
<span class="k">end</span>
</code></pre></div>
<ul>
<li><code>@instance_variables</code> are passed into the view layer. We assign them here.</li>
<li><code>erb</code> declares which template to render.</li>
</ul>

<h2>Our post index template</h2>
<div class="highlight"><pre><code class="erb"><span class="x"># views/posts/index.erb</span>
<span class="x">&lt;h1&gt;Welcome to my blog!&lt;/h1&gt;</span>
<span class="x">&lt;ul&gt;</span>
<span class="cp">&lt;%</span> <span class="vi">@posts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;li&gt;</span>
<span class="x">    &lt;h2&gt;&lt;a href=&quot;/posts/</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="x">&quot;&gt;</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">title</span> <span class="cp">%&gt;</span><span class="x">&lt;/a&gt;</span>
<span class="x">    &lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">pretty_date</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x">&lt;/span&gt;</span>
<span class="x">    &lt;/h2&gt;</span>
<span class="x">  &lt;/li&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;/ul&gt;</span>
</code></pre></div>
<h2>Our layout</h2>

<p>Templates are embedded inside of layouts, and layouts give us a place to put the code that&#39;s common between every template so that our templates can just concern themselves with what&#39;s changed. </p>
<div class="highlight"><pre><code class="erb"><span class="x"># views/layout.erb</span>
<span class="x">&lt;html&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="x">  &lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">title</span> <span class="cp">%&gt;</span><span class="x">&lt;/title&gt;</span>
<span class="x">  </span><span class="cp">&lt;%</span> <span class="nb">puts</span> <span class="n">request</span><span class="o">.</span><span class="n">inspect</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;/head&gt;</span>
<span class="x">&lt;body&gt;</span>
<span class="x">  &lt;ul&gt;</span>
<span class="x">    &lt;li&gt;&lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">    &lt;li&gt;&lt;a href=&quot;/about&quot;&gt;About Me&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">  &lt;/ul&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</code></pre></div>
<p>The <code>yield</code> method is where templates are embedded.</p>

<h1>Some helpers</h1>

<p>You&#39;re notice two methods in the about two files:</p>

<ul>
<li><code>&lt;%= title %&gt;</code></li>
<li><code>&lt;%= pretty_date(post.created_at) %&gt;</code></li>
</ul>

<p>These are defined in a <code>helpers</code> block in our app.rb which are available to any route and view. They let us extract code and simplify our view files. </p>

<p>Here&#39;s what they look like:</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># app.rb</span>
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="n">helpers</span> <span class="k">do</span>
  <span class="c1"># If @title is assigned, add it to the page&#39;s title.</span>
  <span class="k">def</span> <span class="nf">title</span>
    <span class="k">if</span> <span class="vi">@title</span>
      <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@title</span><span class="si">}</span><span class="s2"> -- My Blog&quot;</span>
    <span class="k">else</span>
      <span class="s2">&quot;My Blog&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># Format the Ruby Time object returned from a post&#39;s created_at method</span>
  <span class="c1"># into a string that looks like this: 06 Jan 2012</span>
  <span class="k">def</span> <span class="nf">pretty_date</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
   <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%d %b %Y&quot;</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span> 
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
</code></pre></div>
<h1>The rest of our routes</h1>

<p>Without getting too deep in describing each one, here are all of our routes at once.</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># app.rb</span>

<span class="o">.</span><span class="n">.</span><span class="o">.</span>

<span class="c1"># Get all of our routes</span>
<span class="n">get</span> <span class="s2">&quot;/&quot;</span> <span class="k">do</span>
  <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s2">&quot;created_at DESC&quot;</span><span class="p">)</span>
  <span class="n">erb</span> <span class="ss">:&quot;posts/index&quot;</span>
<span class="k">end</span>

<span class="c1"># Get the New Post form</span>
<span class="n">get</span> <span class="s2">&quot;/posts/new&quot;</span> <span class="k">do</span>
  <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;New Post&quot;</span>
  <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">new</span>
  <span class="n">erb</span> <span class="ss">:&quot;posts/new&quot;</span>
<span class="k">end</span>

<span class="c1"># The New Post form sends a POST request (storing data) here</span>
<span class="c1"># where we try to create the post it sent in its params hash.</span>
<span class="c1"># If successful, redirect to that post. Otherwise, render the &quot;posts/new&quot;</span>
<span class="c1"># template where the @post object will have the incomplete data that the </span>
<span class="c1"># user can modify and resubmit.</span>
<span class="n">post</span> <span class="s2">&quot;/posts&quot;</span> <span class="k">do</span>
  <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:post</span><span class="o">]</span><span class="p">)</span>
  <span class="k">if</span> <span class="vi">@post</span><span class="o">.</span><span class="n">save</span>
    <span class="n">redirect</span> <span class="s2">&quot;posts/</span><span class="si">#{</span><span class="vi">@post</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">else</span>
    <span class="n">erb</span> <span class="ss">:&quot;posts/new&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Get the individual page of the post with this ID.</span>
<span class="n">get</span> <span class="s2">&quot;/posts/:id&quot;</span> <span class="k">do</span>
  <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="vi">@title</span> <span class="o">=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">title</span>
  <span class="n">erb</span> <span class="ss">:&quot;posts/show&quot;</span>
<span class="k">end</span>

<span class="c1"># Get the Edit Post form of the post with this ID.</span>
<span class="n">get</span> <span class="s2">&quot;/posts/:id/edit&quot;</span> <span class="k">do</span>
  <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Edit Form&quot;</span>
  <span class="n">erb</span> <span class="ss">:&quot;posts/edit&quot;</span>
<span class="k">end</span>

<span class="c1"># The Edit Post form sends a PUT request (modifying data) here.</span>
<span class="c1"># If the post is updated successfully, redirect to it. Otherwise,</span>
<span class="c1"># render the edit form again with the failed @post object still in memory</span>
<span class="c1"># so they can retry.</span>
<span class="n">put</span> <span class="s2">&quot;/posts/:id&quot;</span> <span class="k">do</span>
  <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">if</span> <span class="vi">@post</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:post</span><span class="o">]</span><span class="p">)</span>
    <span class="n">redirect</span> <span class="s2">&quot;/posts/</span><span class="si">#{</span><span class="vi">@post</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">else</span>
    <span class="n">erb</span> <span class="ss">:&quot;posts/edit&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Deletes the post with this ID and redirects to homepage.</span>
<span class="n">delete</span> <span class="s2">&quot;/posts/:id&quot;</span> <span class="k">do</span>
  <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
  <span class="n">redirect</span> <span class="s2">&quot;/&quot;</span>
<span class="k">end</span>

<span class="c1"># Our About Me page.</span>
<span class="n">get</span> <span class="s2">&quot;/about&quot;</span> <span class="k">do</span>
  <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;About Me&quot;</span>
  <span class="n">erb</span> <span class="ss">:&quot;pages/about&quot;</span>
<span class="k">end</span>
</code></pre></div>
<h1>All of our templates</h1>

<p>And here are the templates they render:</p>
<div class="highlight"><pre><code class="erb"><span class="x"># views/posts/new.erb</span>
<span class="x">&lt;h1&gt;New Post&lt;/h1&gt;</span>
<span class="x">&lt;form action=&quot;/posts&quot; method=&quot;post&quot;&gt;</span>
<span class="x">  &lt;label for=&quot;post_title&quot;&gt;Title:&lt;/label&gt;&lt;br /&gt;</span>
<span class="x">  &lt;input id=&quot;post_title&quot; name=&quot;post[title]&quot; type=&quot;text&quot; value=&quot;</span><span class="cp">&lt;%=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">title</span> <span class="cp">%&gt;</span><span class="x">&quot; /&gt;</span>
<span class="x">  &lt;br /&gt;</span>

<span class="x">  &lt;label for=&quot;post_body&quot;&gt;Body:&lt;/label&gt;&lt;br /&gt;</span>
<span class="x">  &lt;textarea id=&quot;post_body&quot; name=&quot;post[body]&quot; rows=&quot;5&quot;&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">body</span> <span class="cp">%&gt;</span><span class="x">&lt;/textarea&gt;</span>
<span class="x">  &lt;br /&gt;</span>

<span class="x">  &lt;input type=&quot;submit&quot; value=&quot;Create Post&quot; /&gt;</span>
<span class="x">&lt;/form&gt;   </span>
</code></pre></div><div class="highlight"><pre><code class="erb"><span class="x"># views/posts/show.erb</span>
<span class="x">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">title</span> <span class="cp">%&gt;</span><span class="x">&lt;/h1&gt;</span>
<span class="x">&lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">body</span> <span class="cp">%&gt;</span><span class="x">&lt;/p&gt;</span>
</code></pre></div><div class="highlight"><pre><code class="erb"><span class="x"># views/posts/edit.erb</span>
<span class="x">&lt;h1&gt;Edit Post&lt;/h1&gt;</span>
<span class="x">&lt;form action=&quot;/posts/</span><span class="cp">&lt;%=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="x">&quot; method=&quot;post&quot;&gt;</span>
<span class="x">  &lt;input type=&quot;hidden&quot; name=&quot;_method&quot; value=&quot;put&quot; /&gt; </span>

<span class="x">  &lt;label for=&quot;post_title&quot;&gt;Title:&lt;/label&gt;&lt;br /&gt;</span>
<span class="x">  &lt;input id=&quot;post_title&quot; name=&quot;post[title]&quot; type=&quot;text&quot; value=&quot;</span><span class="cp">&lt;%=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">title</span> <span class="cp">%&gt;</span><span class="x">&quot; /&gt;</span>
<span class="x">  &lt;br /&gt;</span>

<span class="x">  &lt;label for=&quot;post_body&quot;&gt;Body:&lt;/label&gt;&lt;br /&gt;</span>
<span class="x">  &lt;textarea id=&quot;post_body&quot; name=&quot;post[body]&quot; rows=&quot;5&quot;&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">body</span> <span class="cp">%&gt;</span><span class="x">&lt;/textarea&gt;</span>
<span class="x">  &lt;br /&gt;</span>

<span class="x">  &lt;input type=&quot;submit&quot; value=&quot;Edit Post&quot; /&gt;</span>
<span class="x">&lt;/form&gt;   </span>
</code></pre></div>
<ul>
<li>Note: I explained in the routes above that our Edit Post form sends a PUT request, but we use unfortunately the HTML spec only accepts &quot;GET&quot; or &quot;POST&quot; in a <code>&lt;form&gt;</code>&#39;s method attribute. So we instead let Sinatra know that we want this to be a PUT request by specifying it in a hidden form input called <code>_method</code> with a value of <code>put</code>. You also do the same thing in Ruby on Rails and other frameworks.</li>
</ul>
<div class="highlight"><pre><code class="erb"><span class="x"># views/pages/about.erb</span>
<span class="x">&lt;h1&gt;About Me&lt;/h1&gt;</span>
<span class="x">&lt;p&gt;My name is Dan.&lt;/p&gt;</span>
</code></pre></div>
<h1>A navigation bar that lets us add/edit/delete posts</h1>

<p>We want a list of links following us around to each page, so we&#39;ll put it in our layout. So far, our layout already has a convenient link back to our homepage, but we also want links to our About Me page, the New Post form, the Edit Post form of the current post, and a Delete Post button for the current post.</p>

<p>Here&#39;s our completed layout with those links added:</p>
<div class="highlight"><pre><code class="erb"><span class="x"># views/layout.erb</span>
<span class="x">&lt;html&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="x">  &lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">title</span> <span class="cp">%&gt;</span><span class="x">&lt;/title&gt;</span>
<span class="x">&lt;/head&gt;</span>
<span class="x">&lt;body&gt;</span>
<span class="x">  &lt;ul&gt;</span>
<span class="x">    &lt;li&gt;&lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">    &lt;li&gt;&lt;a href=&quot;/about&quot;&gt;About Me&lt;/a&gt;&lt;/li&gt;             </span>
<span class="x">    &lt;li&gt;&lt;a href=&quot;/posts/new&quot;&gt;New Post&lt;/a&gt;&lt;/li&gt;                             </span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">post_show_page?</span>  <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      &lt;li&gt;&lt;a href=&quot;/posts/</span><span class="cp">&lt;%=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="x">/edit&quot;&gt;Edit Post&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">      &lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">delete_post_button</span><span class="p">(</span><span class="vi">@post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x">&lt;/li&gt;</span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/ul&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</code></pre></div>
<p>Note that we only want to see &quot;Edit Post&quot; and &quot;Delete Post&quot; if we&#39;re viewing a post, so I created a <code>post_show_page?</code> helper method that checks the current URL:</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># app.rb</span>

<span class="n">helpers</span> <span class="k">do</span>
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="k">def</span> <span class="nf">post_show_page?</span>
    <span class="n">request</span><span class="o">.</span><span class="n">path_info</span> <span class="o">=~</span> <span class="sr">/\/posts\/\d+$/</span>
  <span class="k">end</span>
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>
</code></pre></div>
<p>It only gets evaluated to true in that if-statement if the current path is <strong>/posts/{number}</strong>, like <strong>/posts/6</strong>.</p>

<p>I&#39;ll explain the delete button next.</p>

<h1>How to make a delete button</h1>

<p>You&#39;ll also notice that I&#39;m using another helper called <code>delete_post_button</code> and you pass in the ID of a post.</p>

<p>Basically, we need a link that can send a DELETE request to our <code>delete &quot;posts/:id&quot;</code> route. However, an <code>&lt;a&gt;</code> tag can only send a GET request. Much like on our Edit Post form, we have to use that <code>&lt;form&gt;</code> method override trickery to make our DELETE button.</p>

<p>In other words, we have to make a small <code>&lt;form&gt;</code>. I didn&#39;t want to bloat up the view with that markup, so I wrote a helper.</p>

<p>Here&#39;s what that helper looks like:</p>
<div class="highlight"><pre><code class="text"># app.rb
...
helpers do
  ...
  def delete_post_button(post_id)
    erb :_delete_post_button, locals: { post_id: post_id}
  end
end
</code></pre></div>
<p>All it does is render a partial template located at <code>views/_delete_post_button.erb</code>. The underscore (_) is a convention I took from Ruby on Rails to distinguish partial templates (templates I want to embed in other templates) from regular templates.</p>

<p>The <code>locals</code> has is used to pass the post id from view view into the final erb partial. We could leave off the locals hash complete and make _delete_post_button.erb except that @post.id will exist, but that&#39;s not very robust and a meek little partial shouldn&#39;t be bothered to know that.</p>
<div class="highlight"><pre><code class="erb"><span class="x"># views/_delete_post_button.erb</span>
<span class="x">&lt;form action=&quot;/posts/</span><span class="cp">&lt;%=</span> <span class="n">post_id</span> <span class="cp">%&gt;</span><span class="x">&quot; method=&quot;post&quot;&gt;</span>
<span class="x">  &lt;input type=&quot;hidden&quot; name=&quot;_method&quot; value=&quot;delete&quot; /&gt; </span>
<span class="x">  &lt;input type=&quot;submit&quot; value=&quot;Delete Post&quot; /&gt;</span>
<span class="x">&lt;/form&gt;</span>
</code></pre></div>
<h1>Adding some validations</h1>

<p>We have some checks in our routes to see if the post is successfully created/updated, but we don&#39;t have a way for a post to fail when trying to save it to the database. </p>

<p>Let&#39;s ensure that a post must:</p>

<ul>
<li>Have a body</li>
<li>Have a title that&#39;s &gt; 3 characters long</li>
</ul>

<p>Pop it into our model:</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># app.rb</span>
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div>
<p>Verify in the tux console:</p>
<div class="highlight"><pre><code class="ruby"><span class="err">$</span> <span class="n">tux</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">new</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="o">.</span><span class="n">valid?</span>
<span class="kp">false</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">messages</span> 
<span class="p">{</span><span class="ss">:title</span><span class="o">=&gt;[</span><span class="s2">&quot;can&#39;t be blank&quot;</span><span class="p">,</span> <span class="s2">&quot;is too short (minimum is 3 characters)&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:body</span><span class="o">=&gt;[</span><span class="s2">&quot;can&#39;t be blank&quot;</span><span class="o">]</span><span class="p">}</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="o">.</span><span class="n">save</span>
<span class="kp">false</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;I have a title now!&quot;</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;And I also have a body! Thanks!&quot;</span>
<span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="o">.</span><span class="n">valid?</span>
<span class="kp">true</span>
</code></pre></div>
<p>Verify on our New Post and Edit Post forms. If you try to save a post with incomplete data, it should drop you back on the form with your data still filled out.</p>

<h1>That&#39;s it!</h1>

<p>Since I extracted this guide from a much longer more verbose guide, I may have cut too many corners. Email me at <code>danrodneu@gmail.com</code> if you have questions or comments.</p>

</div>



<hr />

<h1>Comments</h1>

<div id="disqus_thread"></div>

<script type="text/javascript">
  var disqus_shortname = 'danneu',
      disqus_identifier = 'posts/sinatra-blog-tutorial',
      disqus_title = 'A Simple Blog with Sinatra and Active Record ( + some useful tools)',
      disqus_url = 'http://danneu.composts/15-a-simple-blog-with-sinatra-and-active-record-some-useful-tools',
      disqus_developer = 0;

  (function() {
   var dsq = document.createElement('script');
   dsq.type = 'text/javascript',
   dsq.async = true,
   dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';

   (document.getElementsByTagName('head')[0] || 
    document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

 
    </body>
  </div>
</html>
